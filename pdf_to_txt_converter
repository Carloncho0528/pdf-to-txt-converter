import PyPDF2
import os
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext, messagebox
import threading

class ConvertidorPDFaTXT:
    def __init__(self, root):
        self.root = root
        self.root.title("Conversor PDF a TXT")
        self.root.geometry("700x500")
        self.root.resizable(True, True)
        
        # Variables
        self.archivos_seleccionados = []
        
        # Configurar estilo
        self.configurar_interfaz()
        
    def configurar_interfaz(self):
        # Frame principal
        main_frame = ttk.Frame(self.root, padding="10")
        main_frame.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # Configurar peso de filas y columnas
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(0, weight=1)
        main_frame.columnconfigure(0, weight=1)
        main_frame.rowconfigure(3, weight=1)
        
        # T√≠tulo
        titulo = ttk.Label(main_frame, text="CONVERSOR PDF A TXT", 
                          font=("Arial", 16, "bold"))
        titulo.grid(row=0, column=0, columnspan=3, pady=10)
        
        # Frame de botones
        frame_botones = ttk.Frame(main_frame)
        frame_botones.grid(row=1, column=0, columnspan=3, pady=10, sticky=(tk.W, tk.E))
        frame_botones.columnconfigure(0, weight=1)
        frame_botones.columnconfigure(1, weight=1)
        frame_botones.columnconfigure(2, weight=1)
        
        # Botones principales
        btn_archivos = ttk.Button(frame_botones, text="üìÑ Seleccionar Archivos", 
                                 command=self.seleccionar_archivos)
        btn_archivos.grid(row=0, column=0, padx=5, sticky=(tk.W, tk.E))
        
        btn_carpeta = ttk.Button(frame_botones, text="üìÅ Seleccionar Carpeta", 
                                command=self.seleccionar_carpeta)
        btn_carpeta.grid(row=0, column=1, padx=5, sticky=(tk.W, tk.E))
        
        btn_convertir = ttk.Button(frame_botones, text="üîÑ Convertir", 
                                  command=self.iniciar_conversion,
                                  style="Accent.TButton")
        btn_convertir.grid(row=0, column=2, padx=5, sticky=(tk.W, tk.E))
        
        # Label de informaci√≥n
        self.label_info = ttk.Label(main_frame, text="Archivos seleccionados: 0", 
                                   font=("Arial", 10))
        self.label_info.grid(row=2, column=0, columnspan=3, pady=5)
        
        # √Årea de texto para el log
        frame_log = ttk.LabelFrame(main_frame, text="Log de conversi√≥n", padding="5")
        frame_log.grid(row=3, column=0, columnspan=3, pady=10, sticky=(tk.W, tk.E, tk.N, tk.S))
        frame_log.columnconfigure(0, weight=1)
        frame_log.rowconfigure(0, weight=1)
        
        self.text_log = scrolledtext.ScrolledText(frame_log, height=15, width=80, 
                                                  state='disabled', wrap=tk.WORD)
        self.text_log.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        # Barra de progreso
        self.progress = ttk.Progressbar(main_frame, mode='indeterminate')
        self.progress.grid(row=4, column=0, columnspan=3, pady=5, sticky=(tk.W, tk.E))
        
        # Bot√≥n limpiar
        btn_limpiar = ttk.Button(main_frame, text="üóëÔ∏è Limpiar Log", 
                                command=self.limpiar_log)
        btn_limpiar.grid(row=5, column=0, columnspan=3, pady=5)
        
    def agregar_log(self, mensaje):
        """Agregar mensaje al log"""
        self.text_log.config(state='normal')
        self.text_log.insert(tk.END, mensaje + "\n")
        self.text_log.see(tk.END)
        self.text_log.config(state='disabled')
        self.root.update()
        
    def limpiar_log(self):
        """Limpiar el √°rea de log"""
        self.text_log.config(state='normal')
        self.text_log.delete(1.0, tk.END)
        self.text_log.config(state='disabled')
        
    def seleccionar_archivos(self):
        """Abrir di√°logo para seleccionar archivos PDF"""
        archivos = filedialog.askopenfilenames(
            title="Selecciona archivos PDF",
            filetypes=[("Archivos PDF", "*.pdf"), ("Todos los archivos", "*.*")]
        )
        
        if archivos:
            self.archivos_seleccionados = list(archivos)
            self.label_info.config(text=f"Archivos seleccionados: {len(self.archivos_seleccionados)}")
            self.agregar_log(f"‚úì {len(self.archivos_seleccionados)} archivo(s) seleccionado(s)")
            for archivo in self.archivos_seleccionados:
                self.agregar_log(f"  - {os.path.basename(archivo)}")
        else:
            self.agregar_log("‚úó No se seleccionaron archivos")
            
    def seleccionar_carpeta(self):
        """Abrir di√°logo para seleccionar una carpeta"""
        carpeta = filedialog.askdirectory(title="Selecciona una carpeta")
        
        if carpeta:
            # Buscar todos los PDFs en la carpeta
            archivos_pdf = [os.path.join(carpeta, f) for f in os.listdir(carpeta) 
                          if f.lower().endswith('.pdf')]
            
            if archivos_pdf:
                self.archivos_seleccionados = archivos_pdf
                self.label_info.config(text=f"Archivos seleccionados: {len(self.archivos_seleccionados)}")
                self.agregar_log(f"‚úì Carpeta seleccionada: {carpeta}")
                self.agregar_log(f"‚úì {len(self.archivos_seleccionados)} archivo(s) PDF encontrado(s)")
            else:
                self.agregar_log(f"‚úó No se encontraron archivos PDF en: {carpeta}")
                messagebox.showwarning("Sin archivos", 
                                     "No se encontraron archivos PDF en la carpeta seleccionada")
        else:
            self.agregar_log("‚úó No se seleccion√≥ ninguna carpeta")
            
    def convertir_pdf(self, ruta_pdf):
        """Convierte un PDF a TXT"""
        try:
            ruta_txt = os.path.splitext(ruta_pdf)[0] + '.txt'
            
            with open(ruta_pdf, 'rb') as archivo_pdf:
                lector_pdf = PyPDF2.PdfReader(archivo_pdf)
                num_paginas = len(lector_pdf.pages)
                
                self.agregar_log(f"Procesando: {os.path.basename(ruta_pdf)} ({num_paginas} p√°ginas)")
                
                texto_completo = ""
                for i, pagina in enumerate(lector_pdf.pages, 1):
                    texto = pagina.extract_text()
                    texto_completo += f"\n--- P√°gina {i} ---\n{texto}\n"
                
                with open(ruta_txt, 'w', encoding='utf-8') as archivo_txt:
                    archivo_txt.write(texto_completo)
                
                self.agregar_log(f"‚úì Convertido exitosamente: {os.path.basename(ruta_txt)}")
                return True
                
        except Exception as e:
            self.agregar_log(f"‚úó Error en {os.path.basename(ruta_pdf)}: {str(e)}")
            return False
            
    def proceso_conversion(self):
        """Proceso de conversi√≥n en thread separado"""
        if not self.archivos_seleccionados:
            messagebox.showwarning("Sin archivos", 
                                 "Por favor selecciona archivos o una carpeta primero")
            return
        
        self.progress.start()
        self.agregar_log("\n" + "="*60)
        self.agregar_log("INICIANDO CONVERSI√ìN")
        self.agregar_log("="*60 + "\n")
        
        exitosos = 0
        fallidos = 0
        
        for archivo in self.archivos_seleccionados:
            if self.convertir_pdf(archivo):
                exitosos += 1
            else:
                fallidos += 1
        
        self.progress.stop()
        
        self.agregar_log("\n" + "="*60)
        self.agregar_log("CONVERSI√ìN COMPLETADA")
        self.agregar_log(f"‚úì Exitosos: {exitosos}")
        self.agregar_log(f"‚úó Fallidos: {fallidos}")
        self.agregar_log("="*60 + "\n")
        
        messagebox.showinfo("Conversi√≥n completada", 
                          f"Conversi√≥n finalizada\n\nExitosos: {exitosos}\nFallidos: {fallidos}")
        
    def iniciar_conversion(self):
        """Iniciar conversi√≥n en un thread separado"""
        thread = threading.Thread(target=self.proceso_conversion)
        thread.daemon = True
        thread.start()


def main():
    root = tk.Tk()
    app = ConvertidorPDFaTXT(root)
    root.mainloop()


if __name__ == "__main__":
    main()
